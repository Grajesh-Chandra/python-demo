{% extends "base.html" %}
{% block title %}SecureTrust® Validation{% endblock %}
{% block content %}
<div class="validation-container">
  <div class="validation-header">
    <h1>Validate SecureTrust® PDF</h1>
    <p style="color: #666; margin-top: 0.5rem">
      Verify your document's authenticity
    </p>
  </div>

  <form id="uploadForm">
    <div class="upload-section" id="dropZone">
      <input type="file" id="report_pdf" class="file-input" accept="application/pdf" />
      <button type="button" class="upload-button" onclick="document.getElementById('report_pdf').click()">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
          <polyline points="17 8 12 3 7 8"></polyline>
          <line x1="12" y1="3" x2="12" y2="15"></line>
        </svg>
        Upload from your computer
      </button>
      <div class="drag-drop-text">
        or drag & drop your SecureTrust PDF here
      </div>
    </div>
  </form>

  <div id="responseArea"></div>
  <button id="resetButton" onclick="resetForm()">
    Validate Another Document
  </button>
</div>

<div id="loadingOverlay">
  <div class="loader"></div>
  <div style="margin-top: 1rem; color: #3f51b5; font-weight: 500">
    Validating document...
  </div>
</div>

<script>
  const dropZone = document.getElementById("dropZone");
  const fileInput = document.getElementById("report_pdf");
  const loadingOverlay = document.getElementById("loadingOverlay");
  const responseArea = document.getElementById("responseArea");
  const resetButton = document.getElementById("resetButton");

  // Drag and drop handlers
  dropZone.addEventListener("dragover", (e) => {
    e.preventDefault();
    dropZone.classList.add("dragover");
  });

  dropZone.addEventListener("dragleave", () => {
    dropZone.classList.remove("dragover");
  });

  dropZone.addEventListener("drop", (e) => {
    e.preventDefault();
    dropZone.classList.remove("dragover");
    const files = e.dataTransfer.files;
    if (files.length > 0) handleFile(files[0]);
  });

  fileInput.addEventListener("change", (e) => {
    if (e.target.files.length > 0) handleFile(e.target.files[0]);
  });

  async function handleFile(file) {
    if (file.type !== "application/pdf") {
      alert("Please upload a PDF file.");
      return;
    }

    loadingOverlay.style.display = "flex";
    const formData = new FormData();
    formData.append("report_pdf", file);

    try {
      const response = await fetch("/api/verify_pdf", {
        method: "POST",
        body: formData,
      });

      const data = await response.json();
      displayResults(data);
      resetButton.style.display = "block";
    } catch (error) {
      console.error("Error:", error);
      responseArea.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
    } finally {
      loadingOverlay.style.display = "none";
    }
  }

  function displayResults(data) {
    responseArea.innerHTML = "";
    const container = document.createElement("div");
    container.className = "result-table-container";

    const table = document.createElement("table");
    table.className = "result-table";

    // Table Header
    const thead = document.createElement("thead");
    thead.innerHTML = `
                <tr>
                    <th>Property</th>
                    <th>Value</th>
                    <th>Status</th>
                </tr>
            `;

    // Table Body
    const tbody = document.createElement("tbody");
    data.forEach((item) => {
      const row = document.createElement("tr");

      // Property Cell
      const propCell = document.createElement("td");
      propCell.textContent = item.key;

      // Value Cell
      const valueCell = document.createElement("td");
      valueCell.className = "value-cell";

      if (typeof item.value === "object") {
        const toggleBtn = document.createElement("button");
        toggleBtn.className = "toggle-button";
        toggleBtn.textContent = "Show Details";

        const jsonContent = document.createElement("pre");
        jsonContent.className = "json-content";
        jsonContent.textContent = JSON.stringify(item.value, null, 2);

        toggleBtn.onclick = () => {
          jsonContent.style.display =
            jsonContent.style.display === "none" ? "block" : "none";
          toggleBtn.textContent =
            jsonContent.style.display === "none"
              ? "Show Details"
              : "Hide Details";
        };

        valueCell.innerHTML = "";
        valueCell.append(toggleBtn, jsonContent);
      } else {
        valueCell.textContent = item.value;
      }

      // Status Cell
      const statusCell = document.createElement("td");
      const badge = document.createElement("span");
      badge.className =
        item.result === "Valid" ? "valid-badge" : "invalid-badge";
      badge.textContent = item.result;
      statusCell.appendChild(badge);

      row.append(propCell, valueCell, statusCell);
      tbody.appendChild(row);
    });

    table.append(thead, tbody);
    container.appendChild(table);
    responseArea.appendChild(container);
    resetButton.style.display = "block";
  }

  function resetForm() {
    fileInput.value = "";
    responseArea.innerHTML = "";
    resetButton.style.display = "none";
  }
</script>

{% endblock %}