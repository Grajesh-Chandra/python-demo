<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Report Verification</title>
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
    />
    <style>
      .container {
        background-color: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }

      h1 {
        color: #333;
      }

      .custom-file-label {
        background-color: #fff;
        border: 1px solid #ced4da;
        border-radius: 0.25rem;
        padding: 0.375rem 0.75rem;
      }

      .custom-file-input:focus ~ .custom-file-label {
        border-color: #80bdff;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
      }

      .btn-success {
        background-color: #28a745;
        border-color: #28a745;
      }

      .btn-success:hover {
        background-color: #218838;
        border-color: #1e7e34;
      }

      .btn-warning {
        background-color: #ffc107;
        border-color: #ffc107;
      }

      .btn-warning:hover {
        background-color: #e0a800;
        border-color: #d39e00;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        table-layout: fixed;
        /* Key for consistent cell widths */
      }

      th,
      td {
        border: 1px solid #dee2e6;
        padding: 12px;
        text-align: left;
        vertical-align: top;
        word-wrap: break-word;
        overflow-wrap: break-word;
        white-space: normal;
        /* Most common case */
        background-color: white;
      }

      th {
        background-color: #f8f9fa;
        font-weight: bold;
      }

      pre {
        white-space: pre-wrap;
        word-wrap: break-word;
        overflow-wrap: break-word;
        margin: 0;
        background-color: #f8f9fa;
        padding: 8px;
        border: 1px solid #ced4da;
        overflow-x: auto;
        border-radius: 4px;
      }

      #responseArea.error {
        color: red;
        margin-top: 10px;
      }

      #loadingOverlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        display: none;
      }

      .loader {
        border: 16px solid #f3f3f3;
        border-top: 16px solid #3498db;
        border-radius: 50%;
        width: 120px;
        height: 120px;
        animation: spin 2s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .message {
        color: white;
        margin-top: 20px;
        font-size: 1.2em;
      }
    </style>
  </head>

  <body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
      <a class="navbar-brand" href="/">Home</a>
      <button
        class="navbar-toggler"
        type="button"
        data-toggle="collapse"
        data-target="#navbarNav"
        aria-controls="navbarNav"
        aria-expanded="false"
        aria-label="Toggle navigation"
      >
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav">
          <li class="nav-item">
            <a class="nav-link" href="/create-case">Create New Case</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/orders">Orders</a>
          </li>
        </ul>
      </div>
    </nav>

    <div class="container mt-5">
      <h1 class="text-center">Verify Your Secure Trust PDF</h1>
      <div class="mt-4">
        <form id="uploadForm">
          <div class="custom-file mb-3">
            <input
              type="file"
              class="custom-file-input"
              id="report_pdf"
              name="report_pdf"
              required
            />
            <label class="custom-file-label" for="report_pdf"
              >Choose your final report (PDF)</label
            >
          </div>

          <div class="text-center">
            <button
              type="button"
              class="btn btn-success mr-2"
              id="verifyButton"
            >
              Verify Report
            </button>
            <a id="backLink" href="/verify" class="btn btn-warning">Reset</a>
          </div>
        </form>
      </div>

      <div id="progressBar" style="display: none" class="progress mt-4">
        <div
          class="progress-bar progress-bar-striped"
          role="progressbar"
          aria-valuenow="0"
          aria-valuemin="0"
          aria-valuemax="100"
          style="width: 0%"
        ></div>
      </div>

      <div id="responseArea" class="mt-4"></div>
    </div>

    <div id="loadingOverlay">
      <div class="loader"></div>
      <div class="message">Uploading...</div>
    </div>

    <script>
      const messages = [
        "Uploading...",
        "Processing data...",
        "Validating...",
        "Almost done...",
      ];
      let messageIndex = 0;
      let progress = 0;
      const progressBar = document.querySelector(".progress-bar");
      const progressBarDiv = document.getElementById("progressBar");
      let progressInterval;

      const loadingOverlay = document.getElementById("loadingOverlay");
      const message = document.querySelector(".message");
      const verifyButton = document.getElementById("verifyButton");
      const responseArea = document.getElementById("responseArea");
      const uploadForm = document.getElementById("uploadForm");
      const fileInput = document.getElementById("report_pdf");
      const fileLabel = document.querySelector(".custom-file-label");

      fileInput.addEventListener("change", (e) => {
        fileLabel.textContent =
          e.target.files.length > 0
            ? e.target.files[0].name
            : "Choose a PDF file";
      });

      verifyButton.addEventListener("click", async () => {
        responseArea.innerHTML = "";
        const formData = new FormData(uploadForm);

        loadingOverlay.style.display = "flex";
        message.textContent = messages[messageIndex];
        startProgressInterval();

        try {
          const response = await fetch("/api/verify_pdf", {
            // Replace with your API endpoint
            method: "POST",
            body: formData,
          });

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(
              errorData.error || `HTTP error! status: ${response.status}`
            );
          }

          const data = await response.json();
          displayResults(data);
        } catch (error) {
          console.error("Error:", error);
          responseArea.classList.add("error");
          responseArea.textContent = `Error: ${error.message}`;
        } finally {
          loadingOverlay.style.display = "none";
          clearProgressInterval();
        }
      });

      function startProgressInterval() {
        messageIndex = 0;
        progress = 0;
        progressBarDiv.style.display = "none";
        progressBar.style.width = "0%";
        progressBar.textContent = "";

        progressInterval = setInterval(() => {
          if (progress >= 80) return;

          progress += 20;
          progressBar.style.width = progress + "%";

          if (messageIndex < messages.length) {
            message.textContent = messages[messageIndex];
            messageIndex++;
          }
        }, 300);
      }

      function clearProgressInterval() {
        progressBarDiv.style.display = "none";
        progressBar.style.width = "0%";
        progressBar.textContent = "";
        clearInterval(progressInterval);
        progressInterval = null;
      }

      function displayResults(data) {
        const responseArea = document.getElementById("responseArea");
        responseArea.innerHTML = "";

        if (!Array.isArray(data) || data.length === 0) {
          responseArea.textContent = "No data to display.";
          return;
        }

        const table = document.createElement("table");
        table.classList.add("table", "table-bordered", "mt-4");
        table.style.tableLayout = "fixed";
        table.style.width = "100%";

        const thead = document.createElement("thead");
        const headerRow = document.createElement("tr");

        const headers = ["key", "value", "result"];
        headers.forEach((headerText) => {
          const headerCell = document.createElement("th");
          headerCell.textContent = headerText;
          headerRow.appendChild(headerCell);
        });

        thead.appendChild(headerRow);
        table.appendChild(thead);

        const tbody = document.createElement("tbody");

        data.forEach((item) => {
          const row = document.createElement("tr");

          headers.forEach((headerText) => {
            const cell = document.createElement("td");

            cell.style.overflow = "auto";
            cell.style.maxHeight = "150px"; // Adjust as needed
            cell.style.maxWidth = "300px"; // Adjust as needed
            cell.style.wordBreak = "break-word";
            cell.style.whiteSpace = "normal";

            if (headerText === "value" && typeof item.value === "object") {
              const pre = document.createElement("pre");
              const valueString = JSON.stringify(item.value, null, 2);

              // Create toggle button
              const toggleButton = document.createElement("button");
              toggleButton.textContent = "Show/Hide";
              toggleButton.classList.add(
                "btn",
                "btn-sm",
                "btn-outline-secondary"
              ); // Add Bootstrap styling
              toggleButton.addEventListener("click", () => {
                if (pre.style.display === "none") {
                  pre.style.display = "block";
                  toggleButton.textContent = "Hide"; // Change button text
                } else {
                  pre.style.display = "none";
                  toggleButton.textContent = "Show"; // Change button text
                }
              });

              pre.textContent = valueString;
              pre.style.display = "none"; // Initially hide the pre

              cell.appendChild(toggleButton); // Add button to cell
              cell.appendChild(pre); // Add pre to cell
            } else if (item.hasOwnProperty(headerText)) {
              cell.textContent = item[headerText];
            } else {
              cell.textContent = "";
            }

            if (headerText === "result") {
              if (item[headerText] === "Valid") {
                cell.style.backgroundColor = "lightgreen";
              } else if (item[headerText] === "Invalid") {
                cell.style.backgroundColor = "lightcoral";
              }
            }

            row.appendChild(cell);
          });
          tbody.appendChild(row);
        });

        table.appendChild(tbody);

        table.style.overflowX = "auto"; // Optional: Horizontal table scrolling
        responseArea.appendChild(table);
      }
    </script>
  </body>
</html>
