{% extends "base.html" %}
{% block title %}Orders{% endblock %}
{% block content %}
<div class="validation-container">
  <h2>Orders History</h2>

  <div class="filter-container">
    <select class="form-select" id="orderStatusFilter">
      <option value="all">All Orders</option>
      <option value="pending">Pending Orders</option>
      <option value="completed">Completed Orders</option>
    </select>
  </div>

  <table class="table" id="ordersTable">
    <thead>
      <tr>
        <th>Order ID</th>
        <th>Checks</th>
        <th>Consent</th>
        <th>Action</th>
        <th>Digital Link</th>
        <th>Link Status</th>
        <th>SecureTrust PDF</th>
      </tr>
    </thead>
    <tbody id="ordersTableBody"></tbody>
  </table>

  <div class="no-orders" id="noOrdersMessage" style="display: none">
    No orders found matching your criteria.
  </div>

  <div class="text-center">
    <button class="home-button" onclick="window.location.href='/'">
      <i class="fas fa-home"></i> Return Home
    </button>
  </div>
</div>

<script>
  function populateTable(orders) {
    const tableBody = document.getElementById("ordersTableBody");
    const noOrdersMessage = document.getElementById("noOrdersMessage");
    const ordersTable = document.getElementById("ordersTable");

    tableBody.innerHTML = "";

    if (orders.length === 0) {
      ordersTable.style.display = "none";
      noOrdersMessage.style.display = "block";
      return;
    } else {
      ordersTable.style.display = "table";
      noOrdersMessage.style.display = "none";
    }

    orders.forEach((order) => {
      const row = tableBody.insertRow();

      // Order ID
      const orderIdCell = row.insertCell();
      orderIdCell.textContent = order.orderId;

      // Checks
      const checksCell = row.insertCell();
      checksCell.textContent = order.checks.join(", ");
      checksCell.style.whiteSpace = "normal";

      // Consent
      const consentCell = row.insertCell();
      consentCell.textContent = order.consent ? "Yes" : "No";

      // Action
      const actionCell = row.insertCell();
      const pdfIcon = document.createElement("i");
      pdfIcon.classList.add("fas", "fa-file-pdf", "pdf-icon");
      pdfIcon.title = "View PDF";

      if (order.issuanceState?.status === "VC_CLAIMED") {
        pdfIcon.classList.add("greyed-out");
        pdfIcon.title = "Claimed";
      } else {
        pdfIcon.addEventListener("click", () => {
          window.open("/generate_pdf/" + order.orderId, "_blank");
        });
      }
      actionCell.appendChild(pdfIcon);

      // Digital Link
      const digitalLinkCell = row.insertCell();
      digitalLinkCell.classList.add("digital-link-cell");
      const link = document.createElement("a");
      link.href = order.issuanceResponse.vaultLink;
      link.textContent = "View Link";
      link.target = "_blank";
      link.style.color = "#3f51b5";
      link.style.textDecoration = "none";
      link.style.fontWeight = "500";
      digitalLinkCell.appendChild(link);

      // Link Status
      const linkStatusCell = row.insertCell();
      const statusBadge = document.createElement("span");
      statusBadge.className = `status-badge ${order.issuanceState.status === "VC_CLAIMED"
        ? "status-completed"
        : "status-pending"
        }`;
      statusBadge.textContent = order.issuanceState.status;
      linkStatusCell.appendChild(statusBadge);

      // SecureTrust PDF
      const secureTrustCell = row.insertCell();
      const secureTrustIcon = document.createElement("i");
      secureTrustIcon.classList.add("fas", "fa-file-pdf", "pdf-icon");
      secureTrustIcon.title = "SecureTrust Verified";

      if (order.issuanceState?.status === "VC_CLAIMED") {
        secureTrustIcon.addEventListener("click", () => {
          window.open("/generate_secure_pdf/" + order.orderId, "_blank");
        });
      } else {
        secureTrustIcon.classList.add("greyed-out");
        secureTrustIcon.title = "Not Claimed";
      }
      secureTrustCell.appendChild(secureTrustIcon);
    });
  }

  function loadOrders(filter) {
    let url = "/get_orders";
    if (filter !== "all") {
      url += `?status=${filter}`;
    }
    fetch(url)
      .then((response) => response.json())
      .then((orders) => populateTable(orders))
      .catch((error) => console.error("Error fetching orders:", error));
  }

  // Initial load
  loadOrders("all");

  // Filter change handler
  document
    .getElementById("orderStatusFilter")
    .addEventListener("change", function () {
      loadOrders(this.value);
    });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

{% endblock %}