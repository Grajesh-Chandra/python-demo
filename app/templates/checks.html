{% extends "base.html" %}
{% block title %}Background Checks{% endblock %}
{% block content %}
<div class="validation-container">
  <h2>Background Checks</h2>

  <form id="backgroundCheckForm">
    <div class="form-group">
      <label for="personalInfo">Personal Information Checks</label>
      <input type="checkbox" id="personalInfo" name="personalInfo" checked />
    </div>

    <div class="form-group">
      <label for="address">Address Checks</label>
      <input type="checkbox" id="address" name="address" checked />
    </div>

    <div class="form-group">
      <label for="education">Education Checks</label>
      <input type="checkbox" id="education" name="education" checked />
    </div>

    <div class="form-group">
      <label for="employment">Employment Checks</label>
      <input type="checkbox" id="employment" name="employment" checked />
    </div>

    <div class="form-group">
      <label for="criminality">Civil Litigation Checks</label>
      <input type="checkbox" id="criminality" name="criminality" checked />
    </div>

    <div class="consent-container">
      <input type="checkbox" id="consent" name="consent" required />
      <label for="consent" id="consentLabel">
        I give my consent for the background checks
      </label>
    </div>

    <div class="d-flex gap-2 justify-content-center mt-4">
      <button type="submit" class="btn btn-success" id="submitChecks">
        Create Order
      </button>
      <button type="button" class="btn btn-warning" id="goBackButton">
        Go Back
      </button>
    </div>
  </form>

  <div id="orderConfirmation">
    <h3>Thank you!</h3>
    <p>Your order with selected background checks has been submitted.</p>
    <p>Your Order ID is:</p>
    <div id="orderIdDisplay"></div>
    <p>
      Claim your Digital Credentials using the following transaction code:
    </p>
    <div id="responseDisplay2"></div>
    <button type="button" class="btn btn-info mt-3" onclick="window.location.href='/'">
      Return Home
    </button>
  </div>
</div>

<div id="loadingOverlay">
  <div class="loader"></div>
  <div class="message">Creating Order...</div>
</div>

<script>
  // Keep the existing JavaScript functionality unchanged
  document
    .getElementById("goBackButton")
    .addEventListener("click", function () {
      window.history.back();
    });

  const loadingOverlay = document.getElementById("loadingOverlay");
  const message = document.querySelector(".message");
  const submitButton = document.getElementById("submitChecks");

  submitButton.addEventListener("click", function (event) {
    event.preventDefault();

    const consentCheckbox = document.getElementById("consent");
    if (!consentCheckbox.checked) {
      alert("Please provide your consent to proceed.");
      return;
    }

    const orderId = generateOrderId();
    document.getElementById("orderIdDisplay").textContent = orderId;

    const formData = {
      orderId: orderId,
      checks: {
        personalInfo: document.getElementById("personalInfo").checked,
        address: document.getElementById("address").checked,
        education: document.getElementById("education").checked,
        employment: document.getElementById("employment").checked,
        criminal: document.getElementById("criminality").checked,
      },
      consent: document.getElementById("consent").checked,
    };

    loadingOverlay.style.display = "flex";
    message.textContent = "Creating Order...";

    fetch("/save-order", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify(formData),
    })
      .then((response) => response.json())
      .then((data) => {
        loadingOverlay.style.display = "none";
        if (data.success) {
          document.getElementById("backgroundCheckForm").style.display =
            "none";
          document.getElementById("orderConfirmation").style.display =
            "block";
          document.getElementById("responseDisplay2").textContent =
            data.txCode;
        } else {
          alert("Failed to save order. Please try again.");
        }
      })
      .catch((error) => {
        loadingOverlay.style.display = "none";
        console.error("Error:", error);
        alert("An error occurred. Please try again.");
      });
  });

  function generateOrderId() {
    const timestamp = Date.now().toString(36);
    const random = Math.random().toString(36).substring(2, 8);
    return timestamp + "-" + random.toUpperCase();
  }
</script>

{% endblock %}